<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">

    <title>docs.microsoft.com Table of Content Helper - PoC</title>
    <script type="text/javascript" src="includes/toc-helper.js"></script>
    <link rel="stylesheet" type="text/css" href="includes/toc-helper.css" />

    <script src="assets/fancytree/lib/jquery.js"></script>

    <link href="assets/fancytree/src/skin-win8/ui.fancytree.css" rel="stylesheet">
    <script src="assets/fancytree/src/jquery-ui-dependencies/jquery.fancytree.ui-deps.js"></script>
    <script src="assets/fancytree/src/jquery.fancytree.js"></script>
    <script src="assets/fancytree/src/jquery.fancytree.childcounter.js"></script>
    <script src="assets/fancytree/src/jquery.fancytree.dnd5.js"></script>
    <script src="assets/fancytree/src/jquery.fancytree.edit.js"></script>
    <script src="assets/fancytree/src/jquery.fancytree.filter.js"></script>
    <script src="assets/fancytree/src/jquery.fancytree.wide.js"></script>

    <!-- Initialize the tree when page is loaded -->
    <script type="text/javascript">
        $(function () { // on page load
            // Create the tree inside the <div id="tree"> element.
            $("#tree").fancytree({
                childcounter: {
                    deep: true,
                    hideZeros: true,
                    hideExpanded: true
                },
                dnd5: {
                    dragStart: function (node, data) {
                        return true;
                    },
                    dragDrag: function (node, data) {
                        data.dataTransfer.dropEffect = "move";
                    },
                    dragEnd: function (node, data) {},
                    dragEnter: function (node, data) {
                        // node.debug("dragEnter", data);
                        data.dataTransfer.dropEffect = "move";
                        // data.dataTransfer.effectAllowed = "copy";
                        return true;
                    },
                    dragOver: function (node, data) {
                        data.dataTransfer.dropEffect = "move";
                        // data.dataTransfer.effectAllowed = "copy";
                    },
                    dragLeave: function (node, data) {},
                    dragDrop: function (node, data) {
                        /* This function MUST be defined to enable dropping of items on
                         * the tree.
                         */
                        var transfer = data.dataTransfer;

                        node.debug("drop", data);

                        // alert("Drop on " + node + ":\n"
                        //   + "source:" + JSON.stringify(data.otherNodeData) + "\n"
                        //   + "hitMode:" + data.hitMode
                        //   + ", dropEffect:" + transfer.dropEffect
                        //   + ", effectAllowed:" + transfer.effectAllowed);

                        if (data.otherNode) {
                            // Drop another Fancytree node from same frame
                            // (maybe from another tree however)
                            var sameTree = (data.otherNode.tree === data.tree);

                            data.otherNode.moveTo(node, data.hitMode);
                        } else if (data.otherNodeData) {
                            // Drop Fancytree node from different frame or window, so we only have
                            // JSON representation available
                            node.addChild(data.otherNodeData, data.hitMode);
                        } else {
                            // Drop a non-node
                            node.addNode({
                                title: transfer.getData("text")
                            }, data.hitMode);
                        }
                        node.setExpanded();
                    }
                },
                edit: {
                    triggerStart: ["clickActive", "dblclick", "f2", "mac+enter", "shift+click"],
                    beforeEdit: function (event, data) {
                        // Return false to prevent edit mode
                    },
                    edit: function (event, data) {
                        // Editor was opened (available as data.input)
                    },
                    beforeClose: function (event, data) {
                        // Return false to prevent cancel/save (data.input is available)
                        console.log(event.type, event, data);
                        if (data.originalEvent.type === "mousedown") {
                            // We could prevent the mouse click from generating a blur event
                            // (which would then again close the editor) and return `false` to keep
                            // the editor open:
                            //                  data.originalEvent.preventDefault();
                            //                  return false;
                            // Or go on with closing the editor, but discard any changes:
                            //                  data.save = false;
                        }
                    },
                    save: function (event, data) {
                        // Save data.input.val() or return false to keep editor open
                        console.log("save...", this, data);
                        // Simulate to start a slow ajax request...
                        setTimeout(function () {
                            $(data.node.span).removeClass("pending");
                            // Let's pretend the server returned a slightly modified
                            // title:
                            data.node.setTitle(data.node.title);
                        }, 2000);
                        // We return true, so ext-edit will set the current user input
                        // as title
                        return true;
                    },
                    close: function (event, data) {
                        // Editor was removed
                        if (data.save) {
                            // Since we started an async request, mark the node as preliminary
                            $(data.node.span).addClass("pending");
                        }
                    }
                },
                extensions: ["childcounter", "dnd5", "filter", "wide"],
                icon: true,
                quicksearch: true,
                selectMode: 2,
                source: [{
                        title: "Node 1",
                        key: "1",
                        href: "12"
                    },
                    {
                        title: "Folder 2",
                        key: "2",
                        href: "22",
                        folder: true,
                        children: [{
                                title: "Node 2.1",
                                key: "3",
                                href: "32"
                            },
                            {
                                title: "Node 2.2",
                                key: "4",
                                href: "42"
                            }
                        ]
                    },
                    {
                        title: "Folder 3",
                        key: "5",
                        href: "52",
                        folder: true,
                        children: [{
                            title: "Node 3.1",
                            key: "6",
                            href: "62"
                        }]
                    }
                ],
                filter: {
                    autoApply: true, // Re-apply last filter if lazy data is loaded
                    autoExpand: true, // Expand all branches that contain matches while filtered
                    counter: true, // Show a badge with number of matching child nodes near parent icons
                    fuzzy: false, // Match single characters in order, e.g. 'fb' will match 'FooBar'
                    hideExpandedCounter: true, // Hide counter badge if parent is expanded
                    hideExpanders: false, // Hide expanders if all child nodes are hidden by filter
                    highlight: true, // Highlight matches by wrapping inside <mark> tags
                    leavesOnly: false, // Match end nodes only
                    nodata: true, // Display a 'no data' status node if result is empty
                    mode: "dimm" // Grayout unmatched nodes (pass "hide" to remove unmatched node instead)
                },
                wide: {
                    // iconWidth: "32px",     // Adjust this if @fancy-icon-width != "16px"
                    // iconSpacing: "6px", // Adjust this if @fancy-icon-spacing != "3px"
                    // labelSpacing: "6px",   // Adjust this if padding between icon and label !=  "3px"
                    // levelOfs: "32px"     // Adjust this if ul padding != "16px"
                },
                activate: function (event, data) {
                    $("#statusLine").text(event.type + ": " + data.node);
                    $("#nodeTitle").val(data.node['title']);
                    $("#nodeHref").val(data.node['href']);
                    $("#updateNode").attr("disabled", false);
                },
                loadChildren: function (event, data) {
                    // update node and parent counters after lazy loading
                    data.node.updateCounters();
                }
            });
            // Note: Loading and initialization may be asynchronous, so the nodes may not be accessible yet.

            var tree = $("#tree").fancytree("getTree");

            $("input[name=search]").keyup(function (e) {
                var n,
                    tree = $.ui.fancytree.getTree(),
                    args = "autoApply autoExpand fuzzy hideExpanders highlight leavesOnly nodata".split(
                        " "),
                    opts = {},
                    filterFunc = $("#branchMode").is(":checked") ? tree.filterBranches : tree.filterNodes,
                    match = $(this).val();

                /*
                $.each(args, function (i, o) {
                    opts[o] = $("#" + o).is(":checked");
                });
                */

                /*
                opts.mode = $("#hideMode").is(":checked") ? "hide" : "dimm";
                */

                if (e && e.which === $.ui.keyCode.ESCAPE || $.trim(match) === "") {
                    $("button#btnResetSearch").click();
                    return;
                }

                if ($("#regex").is(":checked")) {
                    // Pass function to perform match
                    n = filterFunc.call(tree, function (node) {
                        return new RegExp(match, "i").test(node.title);
                    }, opts);
                } else {
                    // Pass a string to perform case insensitive matching
                    n = filterFunc.call(tree, match, opts);
                }

                $("button#btnResetSearch").attr("disabled", false);
                $("span#matches").text("(" + n + " matches)");
            }).focus();

            $("button#btnResetSearch").click(function (e) {
                $("input[name=search]").val("");
                $("span#matches").text("");
                tree.clearFilter();
            }).attr("disabled", true);

            /*
            $("fieldset input:checkbox").change(function (e) {
                var id = $(this).attr("id"),
                    flag = $(this).is(":checked");

                // Some options can only be set with general filter options (not method args):
                switch (id) {
                    case "counter":
                    case "hideExpandedCounter":
                        tree.options.filter[id] = flag;
                        break;
                }
                tree.clearFilter();
                $("input[name=search]").keyup();
            });
            */

            $("button#updateNode").click(function (e) {
                var node = $("#tree").fancytree("getActiveNode");
                node.title = $("#nodeTitle").val();
                node.data['href'] = $("input[name=nodeHref]").val();
                node.renderTitle();
            }).attr("disabled", true);;
        });
    </script>
</head>

<body>
    <div id="container">
        <div id="tree_wrapper">
            <div id="button_wrapper">
                <button id="btn_makeCode" onclick="makeCode();">Tree > Code</button>
            </div>
            <div id="filter_wrapper">
                <label>Filter:</label>
                <input name="search" placeholder="Filter..." autocomplete="off">
                <button id="btnResetSearch">&times;</button>
                <span id="matches"></span>
            </div>
            <div id="add">
                <button id="sort_tree" onclick="sortTree();">Sort Tree</button>
                <button id="sort_branch" onclick="sortBranch();">Sort Branch</button>
            </div>
            <div id="edit">
                <label>Node Title</label>
                <input type="text" id="nodeTitle" class="editNode" />
                <label>Node href</label>
                <input type="text" id="nodeHref" class="editNode" />
                <button id="add_node" onclick="add_child();">Add Node</button>
                <button id="updateNode">Update Node</button>
                <button id="toggle_folder" onclick="toggle_folder();">Toggle Folder/Node</button>
            </div>
            <div id="tree" style="resize: both;"> </div>
            <div id="debug">
                <div id="debug_title" style="padding-top: 20px;">
                    <B>DEBUG:</B>
                </div>
                <div id="statusLine" style="padding: 20px; background-color: lightgrey"></div>
            </div>
        </div>
        <div id="code_wrapper">
            <div class="button_wrapper">
                <button class="" onclick="updateTree()">Tree &lt; Code</button>
            </div>
            <div id="code">
                <textarea id="code_text" placeholder="docs.microsoft.com table of contents code goes here..."></textarea>
            </div>
        </div>
        <div style="float: none;" />
    </div>
</body>

</html>